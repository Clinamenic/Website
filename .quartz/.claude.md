# Quartz Build Process Summary

This document provides a comprehensive overview of the Quartz static site generator build process, based on the Meridian-Quartz specialized fork.

## Overview

Quartz is a static site generator that transforms Markdown files into a web-ready format. This specific implementation is optimized for Meridian Digital Garden deployments and runs as a Node.js application with TypeScript support.

## Project Structure

- **Package Configuration**: `package.json` - Defines scripts, dependencies, and project metadata
- **Build Configuration**: `quartz.config.ts` - Main configuration for transformers, filters, emitters
- **CLI Entry Point**: `quartz/bootstrap-cli.mjs` - Command-line interface handler
- **Core Build Logic**: `quartz/build.ts` - Main build orchestration
- **Processing Pipeline**: `quartz/processors/` - Parse, filter, and emit content

## Build Commands

### Available Scripts
```json
{
  "build": "tsx ./quartz/bootstrap-cli.mts build",
  "serve": "tsx ./quartz/bootstrap-cli.mts build --serve",
  "profile": "0x -D prof ./quartz/bootstrap-cli.mts build --concurrency=1",
  "check": "tsc --noEmit && tsx ./quartz/bootstrap-cli.mts update --check"
}
```

### CLI Commands
- `quartz create` - Initialize new Quartz installation
- `quartz build` - Build static site from Markdown files
- `quartz build --serve` - Build and serve with live reload
- `quartz update` - Get latest Quartz updates
- `quartz sync` - Sync with GitHub repository
- `quartz restore` - Restore content from cache

### Build Options
- `--output` (`-o`): Output directory (default: `public`)
- `--serve`: Run local development server
- `--watch`: Watch for changes and rebuild
- `--verbose` (`-v`): Show detailed logging
- `--port`: Server port (default: 8080)
- `--concurrency`: Number of parsing threads

## Core Build Pipeline

### 1. Initialization Phase
- Clean output directory
- Load configuration from `quartz.config.ts`
- Initialize build context with unique build ID
- Scan for input files using glob patterns

### 2. File Discovery
```typescript
// Finds all files, then filters for Markdown
const allFiles = await glob("**/*.*", argv.directory, cfg.configuration.ignorePatterns)
const markdownPaths = allFiles.filter((fp) => fp.endsWith(".md")).sort()
```

### 3. Processing Pipeline
The build follows a three-stage pipeline:

#### Stage 1: Parse (`quartz/processors/parse.ts`)
- **File Reading**: Load Markdown files from disk
- **Text Transformation**: Apply text-level transforms
- **AST Generation**: Parse Markdown to AST using `remark-parse`
- **Markdown Processing**: Apply transformer plugins to Markdown AST
- **HTML Conversion**: Convert Markdown AST to HTML AST using `remark-rehype`
- **HTML Processing**: Apply transformer plugins to HTML AST

#### Stage 2: Filter (`quartz/processors/filter.ts`)
- **Content Filtering**: Apply filter plugins to determine which content should be published
- **Draft Removal**: Filter out draft content based on frontmatter
- **Custom Filters**: Apply any custom filtering logic

#### Stage 3: Emit (`quartz/processors/emit.ts`)
- **Static Resource Collection**: Gather static resources from plugins
- **Content Generation**: Generate HTML pages, indexes, feeds
- **Asset Processing**: Handle CSS, JavaScript, images, and other assets
- **File Output**: Write all generated content to output directory

### 4. Plugin Architecture

#### Transformers
Process content during parsing phase:
- **FrontMatter**: Parse YAML frontmatter
- **CreatedModifiedDate**: Extract file dates
- **Latex**: Render mathematical expressions with KaTeX
- **SyntaxHighlighting**: Code syntax highlighting
- **ObsidianFlavoredMarkdown**: Obsidian-specific Markdown features
- **GitHubFlavoredMarkdown**: GitHub Markdown extensions
- **TableOfContents**: Generate page TOCs
- **CrawlLinks**: Process internal links
- **Description**: Generate page descriptions

#### Filters
Determine which content to publish:
- **RemoveDrafts**: Filter out draft content

#### Emitters
Generate output files:
- **AliasRedirects**: Create redirect pages
- **ComponentResources**: Bundle CSS/JS resources
- **ContentPage**: Generate individual content pages
- **FolderPage**: Generate folder index pages
- **TagPage**: Generate tag pages
- **ContentIndex**: Generate site index, sitemap, RSS
- **Assets**: Process static assets
- **Static**: Copy static files
- **NotFoundPage**: Generate 404 page

## Development Mode

### Watch Mode
When `--watch` is enabled:
- Uses `chokidar` to monitor file changes
- Maintains content map for incremental builds
- Respects `.gitignore` and custom ignore patterns
- Triggers rebuilds on file add/change/delete events

### Live Server
When `--serve` is enabled:
- Starts HTTP server on specified port
- WebSocket connection for live reload
- Serves files from output directory
- Handles redirects and proper MIME types

## Configuration System

### Global Configuration (`quartz.config.ts`)
```typescript
const config: QuartzConfig = {
  configuration: {
    pageTitle: "Rare Compute",
    enableSPA: true,
    enablePopovers: true,
    analytics: null,
    locale: "en-US",
    baseUrl: undefined,
    ignorePatterns: [/* ... */],
    defaultDateType: "created",
    theme: {/* ... */}
  },
  plugins: {
    transformers: [/* ... */],
    filters: [/* ... */],
    emitters: [/* ... */]
  }
}
```

### Key Features
- **Content Directory**: Defaults to `content/`, configurable via `--directory`
- **Ignore Patterns**: Extensive ignore list for development files
- **Theme Configuration**: Custom typography and color schemes
- **Plugin Pipeline**: Configurable processing stages

## Performance Optimizations

### Multi-threading
- Uses `workerpool` for parallel Markdown processing
- Chunks files into groups for optimal memory usage
- Auto-detects optimal concurrency based on file count
- Fallback to single-threaded mode for small builds

### Caching
- Transpiled build cached in `.quartz-cache/`
- Worker scripts pre-transpiled for faster startup
- Module cache bypassing for hot reloading

### Build Optimization
- **ESBuild Integration**: Fast JavaScript/TypeScript compilation
- **CSS Processing**: SASS compilation with bundling
- **Minification**: Whitespace and syntax minification
- **Source Maps**: Generated for debugging

## Error Handling

### Build Failures
- Graceful error handling for malformed Markdown
- Detailed error traces with file context
- Build continues despite individual file failures
- Comprehensive logging at multiple verbosity levels

### Development Features
- File watching with proper cleanup
- Mutex-based build serialization
- Hot module reloading
- WebSocket-based client refresh

## Meridian-Specific Features

This fork includes specialized configuration for Meridian Digital Gardens:
- Content sourced from parent directory (workspace root)
- Pre-configured ignore patterns for `.meridian/` infrastructure
- Optimized for `.quartz/` installation location
- Custom color scheme and typography
- Future integration points for Meridian-specific plugins

## Build Output

The build process generates:
- **HTML Pages**: Individual content pages with full navigation
- **Static Assets**: CSS, JavaScript, fonts, images
- **Index Files**: Site-wide content index and search data
- **Feed Files**: RSS and Atom feeds
- **Sitemap**: XML sitemap for search engines
- **Redirect Files**: Alias-based redirects

## Dependencies

### Core Dependencies
- **Node.js**: Runtime (â‰¥22.0.0)
- **TypeScript**: Language support
- **ESBuild**: Fast compilation and bundling
- **Unified**: Content processing pipeline
- **Remark/Rehype**: Markdown/HTML processing

### Processing Libraries
- **Gray Matter**: Frontmatter parsing
- **KaTeX**: Mathematical expression rendering
- **Shiki**: Syntax highlighting
- **D3**: Graph visualizations
- **Preact**: Component rendering

This build system provides a robust, performant foundation for generating static sites from Markdown content with extensive customization options and development-friendly features.
